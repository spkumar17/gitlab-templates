

# ---------------------------------------------------------------
# ðŸ“¦ CI/CD Variables (define in GitLab â†’ Settings â†’ CI/CD â†’ Variables)
# ---------------------------------------------------------------

# CI_REGISTRY_IMAGE:      Full path to the Docker Hub image repository
#                         Example: docker.io/Boutique-store/microserviceimage
#                         Set this if you're pushing to Docker Hub

# SERVICE_NAME:           Logical name of the microservice (used in tagging and naming)
#                         Example: ADservice

# DOCKERHUB_USERNAME:     Your Docker Hub username (e.g., 'prasanna17')
#                         Store this as a **masked and protected** secret variable

# DOCKERHUB_PASSWORD:     Your Docker Hub password or personal access token (recommended)
#                          Store this as a **masked and protected** secret variable

# define these variables under:
# GitLab â†’ Project â†’ Settings â†’ CI/CD â†’ Variables

# ðŸ“¦ This template depends on the Docker build stage.
# It loads the Docker image from a .tar file that was generated and saved as an artifact during the build.
# âž¤ When using this template, ensure the corresponding Docker build job is added as a dependency
#    using 'dependencies' and/or 'needs' so that the .tar file is available in this stage.

# ---------------------------------------------------------------

.docker_push_template:
  stage: DockerPush
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_VERIFY: "0"
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""

  script:
    - apk add --no-cache docker-cli
    - docker info || echo "Docker daemon not reachable"
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - echo "Pushing Docker image for $SERVICE_NAME and commit ID $CI_COMMIT_SHORT_SHA..."
    - docker load -i $SERVICE_NAME-$CI_COMMIT_SHORT_SHA.tar
    - docker push "$CI_REGISTRY_IMAGE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA"
    - docker push "$CI_REGISTRY_IMAGE/$SERVICE_NAME:latest"
  cache:
    key: "$SERVICE_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .docker_cache/
    policy: pull-push

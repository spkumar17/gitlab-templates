.Test_python_template:
  stage: test
  image: python:3.11-alpine
  variables:
    PYTHONUNBUFFERED: 1

  script:
    - apk add --update --no-cache build-base
    - echo "--- Creating virtual environment and installing dependencies ---"
    - python -m venv .venv
    - . .venv/bin/activate
    - pip install --no-cache-dir -r requirements.txt
    - mkdir -p test_results
    - |
      echo "--- Running tests ---"
      if pytest --collect-only > /dev/null 2>&1; then
        pytest --junitxml=$CI_PROJECT_DIR/test_results/${CI_PIPELINE_ID}-test_results.xml
      else
        echo "No test files found. Skipping test execution."
      fi

  artifacts:
    when: always
    paths:
      - $CI_PROJECT_DIR/test_results/
    expire_in: 1 day

  cache:
    key: "python-$CI_COMMIT_REF_SLUG"
    paths:
      - .venv/
    policy: pull-push

# --------------------------------------------------------------------
# Trivy Docker Image Scan Template for GitLab CI
# --------------------------------------------------------------------
# This job pulls and scans a Docker image using Trivy. It does not 
# require Docker-in-Docker or certificate setup. Assumes the image 
# is already pushed to a registry and accessible.
# --------------------------------------------------------------------

.trivy-imagescan:
  stage: dockerimagescan

  variables:
    TRIVY_VERSION="0.51.0"
  script:
    - echo "Installing Trivy v$TRIVY_VERSION..."
    - curl -sfL https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz -o trivy.tar.gz
    - tar -xzf trivy.tar.gz
    - mv trivy /usr/local/bin/trivy
    - echo "Trivy installed successfully."
    - trivy --version # Verify installation
    - docker load -i $CI_PROJECT_DIR/$SERVICE_NAME-$CI_COMMIT_SHORT_SHA.tar
    - trivy image --input $CI_PROJECT_DIR/$SERVICE_NAME-$CI_COMMIT_SHORT_SHA.tar --format table --output $CI_PROJECT_DIR/trivy-image-scan.txt
    - echo "Scan complete. Output saved to trivy-image-scan-$CI_JOB_NAME.txt"

  artifacts:
    paths:
      - $CI_PROJECT_DIR/trivy-image-scan-$CI_JOB_NAME.txt
    expire_in: 1 day
    when: always

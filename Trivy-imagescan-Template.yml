# --------------------------------------------------------------------
# Trivy Docker Image Scan Template for GitLab CI
# --------------------------------------------------------------------
# This job pulls and scans a Docker image using Trivy. It does not
# require Docker-in-Docker or certificate setup. Assumes the image
# is already pushed to a registry and accessible.
# --------------------------------------------------------------------

.trivy-imagescan:
  image: aquasec/trivy:0.51.0
  stage: dockerimagescan

  # No TRIVY_VERSION variable needed if using snap, as snap manages versions
  # unless you're pinning to a specific channel (e.g., --channel=stable/edge)
  script:
    - trivy image --input $CI_PROJECT_DIR/$SERVICE_NAME-$CI_COMMIT_SHORT_SHA.tar --format table --output $CI_PROJECT_DIR/trivy-image-scan-$CI_JOB_NAME.txt
    - echo "Scan complete. Output saved to $CI_PROJECT_DIR/trivy-image-scan-$CI_JOB_NAME.txt"

  artifacts:
    paths:
      - $CI_PROJECT_DIR/trivy-image-scan-$CI_JOB_NAME.txt
    expire_in: 1 day
    when: always
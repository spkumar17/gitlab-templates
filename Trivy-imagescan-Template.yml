# --------------------------------------------------------------------
# Trivy Docker Image Scan Template for GitLab CI
# --------------------------------------------------------------------
# This job pulls and scans a Docker image using Trivy. It does not 
# require Docker-in-Docker or certificate setup. Assumes the image 
# is already pushed to a registry and accessible.
# --------------------------------------------------------------------

.trivy-imagescan:
  image: ubuntu:22.04
  stage: dockerimagescan

  script:
    - apt-get update -y
    - apt-get install -y curl ca-certificates
    - echo "Installing Trivy..."
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

    - echo "Running Trivy image scan on $CI_REGISTRY_IMAGE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA"
    - trivy image --scanners vuln --format table --output trivy-image-scan-$CI_JOB_NAME.txt $CI_REGISTRY_IMAGE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA
    - echo "Scan complete. Output saved to trivy-image-scan-$CI_JOB_NAME.txt"

  artifacts:
    paths:
      - trivy-image-scan-$CI_JOB_NAME.txt
    expire_in: 1 day
    when: always

  allow_failure: true

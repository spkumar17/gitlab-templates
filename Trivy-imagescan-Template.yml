# --------------------------------------------------------------------
# Trivy Docker Image Scan Template for GitLab CI
# --------------------------------------------------------------------
# This job pulls and scans a Docker image using Trivy. It does not 
# require Docker-in-Docker or certificate setup. Assumes the image 
# is already pushed to a registry and accessible.
# --------------------------------------------------------------------

.trivy-imagescan:
  stage: dockerimagescan

  script:
    - echo "Installing Trivy..."
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    - echo "Running Trivy image scan on $CI_REGISTRY_IMAGE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA"
    - docker load -i $CI_PROJECT_DIR/$SERVICE_NAME-$CI_COMMIT_SHORT_SHA.tar
    - trivy image --input $CI_PROJECT_DIR/$SERVICE_NAME-$CI_COMMIT_SHORT_SHA.tar --format table --output $CI_PROJECT_DIR/trivy-image-scan.txt
    - echo "Scan complete. Output saved to trivy-image-scan-$CI_JOB_NAME.txt"

  artifacts:
    paths:
      - $CI_PROJECT_DIR/trivy-image-scan-$CI_JOB_NAME.txt
    expire_in: 1 day
    when: always
